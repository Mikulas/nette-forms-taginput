<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

	<meta name="description" content="Nette Framework web application skeleton">
	<meta name="robots" content="{$robots}" n:ifset="$robots">

	<title>Nette Application Skeleton</title>

	<link rel="stylesheet" media="screen,projection,tv" href="{$basePath}/css/screen.css" type="text/css">
	<link rel="stylesheet" media="print" href="{$basePath}/css/print.css" type="text/css">

	<link rel="shortcut icon" href="{$basePath}/favicon.ico" type="image/x-icon">

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>
	<script type="text/javascript" src="{$basePath}/js/netteForms.js"></script>

    <style>
    body {background-color: #DDD; font-family: LucidaGrande; font-size: 11px; width: 100%; height: 100%;}
    .tag-control-container {background: #FFF; padding: 3px; display: block; width: 300px; max-width: 300px;}
    .tag-control-container input.tag-control-helper {border: 0; width: 100%; border-top: 1px #A4BDED solid;}
    .tag-control-container input.tag-control-helper:focus {outline: none;}
    .tag-control-container .tag-value span {background-color: #DEE7F8; -moz-border-radius: 9px; border-radius: 9px; padding: 0 1em 0 1em; border: 1px #A4BDED solid; line-height: 170%;}
    .tag-control-container .tag-value span:hover {background-color: #BBCEF1; border-color: #6D95E0;}
    .tag-control-container .tag-value span.focus {background-color: #598AEC; border-color: #598AEC; color: #FFF;}
    </style>
</head>

<body>
    <input type="text" class="tag-control" id="nette-form-tag-supertagga" data-tag-delimiter="\s*[,]+\s*">
	<ol>
        <li>tags longer then control width do not wrap property (at all)</li>
        <li>add multi-select support</li>
        <li><strike>make item unique</strike> and validate this in php server-side</li>
        <li>(fixed?) fix input tag-helper selectors</li>
	    <li>(really?) objectify</li>
	</ol>
	<script>
	$(function() {
	    var default_delimiter = /[\s,]+/;
        $('input.tag-control').hide();
        
        $('input.tag-control').each(function(index) {
            $(this).parent().append('<span class="tag-control-container" for="' + $(this).attr('id')  + '"></span>');
            $control = $('.tag-control-container[for=' + $(this).attr('id') + ']'); // todo fixme
            $(this).appendTo($control);
            $control.append('<input type="text" class="tag-control-helper">');
            $control.prepend('<span class="tag-value"></span>');
        });        
        
        $('input.tag-control-helper').change(function() {
            $control = $(this).parent().children('.tag-value');
            $main = $(this).siblings('input.tag-control');
            delimiter = $main.attr('data-tag-delimiter') == undefined ? default_delimiter : new RegExp($main.attr('data-tag-delimiter'));
            $.each($(this).val().split(delimiter), function(index, value) {
                // &nbsp; fixes wrapping problem
                isUnique = true;
                $control.children('span').each(function() {
                    if (value == $(this).text()) {
                        isUnique = false;
                    }
                });
                if (value.trim() != '' && isUnique) {
                    $control.append('<span>' + value + '</span>&nbsp; ');
                }
            });
            $(this).val('');
            $main.updateValue();
        });
        
        $('html').live('click', function(event) {
            $('.tag-control-container .tag-value span').removeClass('focus');
            if ($(event.target).is('.tag-control-container .tag-value span')) {
                $(event.target).addClass('focus');
            }
        });
        
        var keylock = false;
        $('*').keydown(function(e) {
            if (keylock) {
                return;
            }
            keylock = true;
            
            if (e.keyCode == 8 || e.keyCode == 46) { // backspace or delete
                // if input is focused and has value
                if ($('input.tag-control-helper:focus').size() != 0 && $('input.tag-control-helper:focus').val() != '') {
                    return;
                }
                
                $control = $('.tag-control-container .tag-value span.focus');
                $node = $control.parent();
                
                if ($control.size() != 0) {
                    // if element on right exists
                    if ($control.next().size() != 0) {
                        $control.next().addClass('focus');
                        // else if element on left exists
                    } else if ($control.prev().size() != 0) {
                        $control.prev().addClass('focus');
                    } else {
                        $control.parent().siblings('input.tag-control-helper').focus();
                    }
                    $control.remove();
                }
                
                // if in empty focused input, remove last tag on backspace
                if (e.keyCode == 8 && $('input.tag-control-helper:focus').size() != 0) {
                    $('input.tag-control-helper:focus').siblings('.tag-value').children('span:last').remove();
                    $node = $('input.tag-control-helper:focus').siblings('.tag-value');
                }
                
                // normalize count of &nbsp;
                
                normalized = $node.html().replace(/(&nbsp;\s+){2,}/g, '&nbsp; ').replace(/^&nbsp;\s+/, '');
                $node.html(normalized);
                $node.siblings('input.tag-control').updateValue();
                
            // pressed arrow key
            } else if (e.keyCode >= 37 && e.keyCode <= 40) {
                left = e.keyCode == 37 || e.keyCode == 38;
                $span = $('.tag-control-container .tag-value span.focus');
                if ($span.size() != 0) { // if any tag is focused
                    if (left) {
                        if ($span.prev().size() == 0) { // if not most left
                            return;
                        } else {
                            $span.prev().addClass('focus');
                        }
                    } else {
                        if ($span.next().size() == 0) { // if most right
                            $span.parent().siblings('input.tag-control-helper').focus();
                        } else {
                            $span.next().addClass('focus');
                        }
                    }
                    $span.removeClass('focus');
                } else if (left) {
                    $('input.tag-control-helper:focus').siblings('.tag-value').children('span' + left ? ':last' : ':first').addClass('focus');
                    $('input.tag-control-helper:focus').blur();
                }
                return false;
            }
        }).keyup(function(e) {
            keylock = false;
        });
        
        
        // debug
        $('input.tag-control-helper').val('Vanoce Time 0 0').trigger('change');
	});
	
    $.fn.updateValue = function() {
        var value = [];
        $(this).siblings('.tag-value').children('span').each(function() {
            value.push($(this).text());
        });
        $(this).val(value.join(', '));
        return $(this);
    }
	</script>
</body>
</html>
